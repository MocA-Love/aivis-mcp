# Changelog

## [1.1.0] - 2025-02-08

### CLIの即時返却対応

CLIコマンド (`aivis "テキスト"`) がMCPと同じRedisキュー経由で動作するようになりました。
音声合成・再生の完了を待たずに即座にコマンドが返ります。

- 変更前: `synthesizeAndPlay()` を直接呼び出し、再生完了まで待機
- 変更後: Redisキューにエンキューして即座に終了。ワーカーがバックグラウンドで再生

ワーカーが起動していない場合は自動的に起動します。

### 排他制御の修正

CLI側の安全でない play-lock 実装を廃止しました。

- 変更前: CLI が固定値 `'1'` でロック取得し、`DEL` で無条件解放 → 他プロセスのロックを誤って解放する可能性があった
- 変更後: ワーカーのみが play-lock を管理。Lua スクリプトで自分のロックだけを安全に解放

### `aivis --health` コマンド追加

環境の状態を一覧で確認できるヘルスチェックコマンドを追加しました。

```
=== aivis health check ===

API Key:       OK
Redis:         OK (redis://127.0.0.1:6379)
Worker:        OK
Queue:         0 件
Play Lock:     空き
Processes:     2 件
  Workers:     1
  MCP Servers: 1
Audio Player:  OK (ffplay, afplay)
Model UUID:    デフォルト
```

確認項目:
- API Key の設定有無
- Redis の接続状態
- ワーカープロセスの稼働状況
- キューの滞留件数
- play-lock の使用状態
- プロセスの多重起動検出（ワーカー / MCP サーバー を区別して表示）
- 音声プレイヤーの検出状況
- 使用中のモデル UUID

### `aivis --reboot` コマンド追加

全プロセスの停止・Redis初期化・ワーカー再起動を一括で行うコマンドを追加しました。
ビルド後に最新コードへ切り替えたい時や、多重起動を解消したい時に使用します。

処理内容:
1. 既存のワーカープロセスを SIGTERM で停止
2. MCP サーバープロセスを停止（クライアントが自動で再起動）
3. Redis の `aivis-mcp:*` キーを全削除
4. 新しいワーカーを起動

### `npm install` 時の自動セットアップ

`npm install` 実行時に自動でビルドと `npm link` が行われ、`aivis` コマンドがグローバルに登録されるようになりました。
手動で `npm run build` や `npm link` を実行する必要はありません。

### ワーカープロセスの識別

ワーカー起動時に `--worker` 引数を付与するようにしました。
`ps` コマンドやヘルスチェックでワーカーと MCP サーバーを区別できます。
